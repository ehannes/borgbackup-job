#!/bin/bash

PATHS_TO_BACKUP=("$@")

# Some helpers and error handling
info() {
  # print timestamped info on stderr
  printf "\n%(%F_%T)T %s\n" -1 "$*" >&2
}
die() {
  # exit with indicated exit code and message on stderr
  exitcode=$1
  shift
  info "$*"
  exit "$exitcode"
}
warning_or_error() {
  # borg exit code = 1 is warning, others are error.
  # This translates the code to text used in message to user
  code=$1
  ret="warning"
  [[ $code -gt 1 ]] && ret="error"
  echo $ret
}
trap 'echo $( date ) Backup interrupted >&2; exit 2' INT TERM

info "Starting borg backup"

borg create                       \
     --stats                      \
     --show-version               \
     --show-rc                    \
     --filter AME                 \
     --list                       \
                                  \
     ::'{now:%Y-%m-%dT%H:%M:%S}'  \
     "${PATHS_TO_BACKUP[@]}" \
  || die $? "borg create ended with $(warning_or_error $?). Not pruning repository"

info "Pruning repository"

borg prune             \
    --list             \
    --show-rc          \
    --keep-daily    14 \
    --keep-weekly   4  \
    --keep-monthly  12 \
    --keep-yearly   5  \
  || die $? "borg prune ended with $(warning_or_error $?)."
